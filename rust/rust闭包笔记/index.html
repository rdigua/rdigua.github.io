<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="//gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.59.0-DEV" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title> &middot; Jay Blog</title>

  
  <link type="text/css" rel="stylesheet" href="http://blog.jaytogo.com/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="http://blog.jaytogo.com/css/poole.css">
  <link type="text/css" rel="stylesheet" href="http://blog.jaytogo.com/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="http://blog.jaytogo.com/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  
</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="http://blog.jaytogo.com/"><h1>Jay Blog</h1></a>
      <p class="lead">
       learning rust, reviwe c, erp, javascript, blog, python 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="http://blog.jaytogo.com/">Home</a> </li>
        <li><a href="/rust/"> rust </a></li>
      </ul>
    </nav>

    <p>&copy; 2019. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1></h1>
  <time datetime=0001-01-01T00:00:00Z class="post-date">Mon, Jan 1, 0001</time>
  

<h1 id="rust-é—­åŒ…ç¬”è®°-https-www-linyinfeng-com-posts-how-do-rust-closures-work"><a href="https://www.linyinfeng.com/posts/how-do-rust-closures-work/">Rust é—­åŒ…ç¬”è®°</a></h1>

<p>2019-03-15 11:06</p>

<p><a href="https://www.linyinfeng.com/tags">Tags</a><a href="https://www.linyinfeng.com/tags/rust/">Rust</a><a href="https://www.linyinfeng.com/tags/bi-bao/">é—­åŒ…</a><a href="https://www.linyinfeng.com/tags/han-shu-shi-bian-cheng/">å‡½æ•°å¼ç¼–ç¨‹</a> <a href="https://www.linyinfeng.com/categories">Categories</a><a href="https://www.linyinfeng.com/categories/bi-ji/">ç¬”è®°</a></p>

<p><img src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" alt="Creative Commons License" /></p>

<p>This work is licensed under a  <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a></p>

<p>è¿‘æ—¥åœ¨å­¦ä¹  Rust è¯­è¨€ã€‚Rust è¯­è¨€çš„é—­åŒ…è®¾è®¡éå¸¸æœ‰è¶£ï¼Œä¸€æ–¹é¢ï¼Œå®ƒçœ‹èµ·æ¥éå¸¸å¤æ‚ï¼Œä¸ºäº†æ”¯æŒé—­åŒ…è®¾è®¡äº†ä¸‰ç§ä¸åŒçš„ traitï¼Œ<code>Fn</code>ã€<code>FnMut</code>  å’Œ  <code>FnOnce</code>ï¼›ä¸€æ–¹é¢å…¶è®¾è®¡åˆé€éœ²å‡ºäº†è¯­è¨€è®¾è®¡ä¸­é—­åŒ…çš„æœ¬è´¨ã€‚é€šè¿‡è€ƒå¯Ÿ Rust é—­åŒ…çš„è®¾è®¡ï¼Œæˆ‘ä»¬èƒ½æ›´å¥½çš„ç†è§£é—­åŒ…åˆ°åº•æ˜¯ä»€ä¹ˆï¼Œåœ¨æ‹¥æœ‰ç”Ÿå­˜æœŸå’Œå€Ÿç”¨æ£€æŸ¥çš„è¯­è¨€ Rust ä¸­ï¼Œé—­åŒ…å¦‚ä½•å·¥ä½œã€‚</p>

<p>æœ¬æ–‡å°†åœ¨ Rust ä¸‹å®ç°ä¸€ä¸ªèƒ½å¤Ÿé˜è¿°é—­åŒ…å·¥ä½œåŸç†çš„æœ´ç´ ç‰ˆé—­åŒ…ï¼ˆä¹Ÿæ˜¯ä¸€ä¸ª Boxed Closureï¼‰ã€‚å¹¶åœ¨å®ç°çš„åŸºç¡€ä¸Šå¯¹ Rust é—­åŒ…ä½œè¿›ä¸€æ­¥æ¢ç©¶ã€‚</p>

<h2 id="https-www-linyinfeng-com-posts-how-do-rust-closures-work-bi-bao-de-gai-nian-é—­åŒ…çš„æ¦‚å¿µ"><a href="https://www.linyinfeng.com/posts/how-do-rust-closures-work/#bi-bao-de-gai-nian">ğŸ”—</a>  é—­åŒ…çš„æ¦‚å¿µ</h2>

<p>é—­åŒ…ï¼ˆClosureï¼‰æ˜¯ä¸€ä¸ªåœ¨è®¡ç®—æœºç§‘å­¦ä¸­å¹¿æ³›ä½¿ç”¨çš„æ¦‚å¿µï¼Œåˆå«è¯æ³•é—­åŒ…ï¼ˆLexical Closureï¼‰ã€‚å³é—­åŒ…èƒ½å¤Ÿâ€œæ•è·â€è¯æ³•ä½œç”¨åŸŸä¸­çš„å˜é‡ï¼Œè¿™æ˜¯ä¸ç¼–è¯‘æ—¶ä»£ç çš„ç»“æ„ç›´æ¥ç›¸å…³çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨<strong>å£°æ˜é—­åŒ…è€Œä¸æ˜¯é—­åŒ…è¢«è°ƒç”¨çš„æ—¶å€™</strong>ï¼Œå…¶å‡½æ•°ä½“å¯ä»¥æ•è·å¤–å›´è¯æ³•ä½œç”¨åŸŸä¸­çš„å˜é‡ã€‚</p>

<h3 id="https-www-linyinfeng-com-posts-how-do-rust-closures-work-bi-bao-shi-ni-ming-han-shu-ma-é—­åŒ…æ˜¯åŒ¿åå‡½æ•°å—"><a href="https://www.linyinfeng.com/posts/how-do-rust-closures-work/#bi-bao-shi-ni-ming-han-shu-ma">ğŸ”—</a>  é—­åŒ…æ˜¯åŒ¿åå‡½æ•°å—ï¼Ÿ</h3>

<p>è¿™ä¸¤ä¸ªæ¦‚å¿µä¹‹é—´æ²¡æœ‰ä»€ä¹ˆå…³ç³»ï¼Œå°±ä»¥<a href="https://en.wikipedia.org/wiki/Closure_(computer_programming)">ç»´åŸºç™¾ç§‘ Closure è¯æ¡</a>ä¸Šä¸¾çš„ä¸€ä¸ªå¸¸è§çš„  <code>adder</code>  ä¾‹å­æ¥è¯´ï¼š</p>

<h3 id="python">Python</h3>

<pre><code class="language-python">def f(x): def g(y): return x + y return g def h(x): return lambda y: x + y
a = f(1)
b = h(1)
</code></pre>

<p>åœ¨è¿™ä¸¤ä¸ªä¾‹å­ä¸­ï¼Œa å’Œ b å‡ä¸ºé—­åŒ…ï¼ŒJavaScript ä¸­çš„  <code>function</code>  ä¹Ÿæ˜¯ä¸€æ ·ï¼Œæ˜¯ä¸æ˜¯é—­åŒ…å½“ç„¶å’Œæ²¡æœ‰åå­—å¹¶æ²¡æœ‰ç†è®ºå’Œå®è·µä¸Šçš„è”ç³»ã€‚å½“ç„¶ï¼Œå¯ä»¥è¯´å¯¹äºå°†å‡½æ•°è®¾è®¡ä¸ºä¸€ç­‰å¯¹è±¡ï¼ˆFirst class objectï¼‰çš„è¯­è¨€ï¼Œå‡½æ•°æ˜¯å¦åŒ¿åä¸€èˆ¬ä¸äº§ç”Ÿä»»ä½•å®é™…åŒºåˆ«ã€‚</p>

<h3 id="https-www-linyinfeng-com-posts-how-do-rust-closures-work-bi-bao-tong-chang-bei-shi-xian-wei-ci-fa-huan-jing-he-yi-ge-han-shu-de-zu-he-é—­åŒ…é€šå¸¸è¢«å®ç°ä¸ºè¯æ³•ç¯å¢ƒå’Œä¸€ä¸ªå‡½æ•°çš„ç»„åˆ"><a href="https://www.linyinfeng.com/posts/how-do-rust-closures-work/#bi-bao-tong-chang-bei-shi-xian-wei-ci-fa-huan-jing-he-yi-ge-han-shu-de-zu-he">ğŸ”—</a>  é—­åŒ…é€šå¸¸è¢«å®ç°ä¸ºè¯æ³•ç¯å¢ƒå’Œä¸€ä¸ªå‡½æ•°çš„ç»„åˆ</h3>

<p>å¯¹äºå‡½æ•°åŸºäºæ ˆçš„ä¸”æ²¡æœ‰åƒåœ¾å›æ”¶ï¼ˆGarbage Collectionï¼‰çš„è¯­è¨€ï¼Œå¾€å¾€æ— æ³•å®ç°å®Œå…¨çš„é—­åŒ…ã€‚è¿™æ˜¯å› ä¸ºï¼Œé—­åŒ…ä»è¯­ä¹‰ä¸Šåº”å½“èƒ½å¤Ÿå»¶é•¿å…¶æ•è·çš„å˜é‡çš„ç”Ÿå­˜æœŸï¼ˆlifetimeï¼‰åˆ°é•¿äºæˆ–ç­‰äºé—­åŒ…çš„ç”Ÿå­˜æœŸã€‚å¯¹äºå¹¿æ³›åˆ©ç”¨æ ˆè¿›è¡Œå‡½æ•°å±€éƒ¨å˜é‡åˆ†é…å’Œæµç¨‹æ§åˆ¶çš„è¯­è¨€ï¼Œå‡½æ•°çš„å±€éƒ¨å˜é‡çš„ç”Ÿå­˜æœŸä¸¥æ ¼ä¸å‡½æ•°è°ƒç”¨æ ˆç»‘å®šï¼Œå³ä»å‡½æ•°è°ƒç”¨åˆ°å‡½æ•°è¿”å›ï¼ˆä¸¥æ ¼æ¥è¯´æ˜¯å±€éƒ¨å˜é‡å†…å­˜çš„ç”Ÿå­˜æœŸï¼Œæ˜¾ç„¶å±€éƒ¨å˜é‡çš„ç”Ÿå­˜æœŸå¿…ç„¶å°äºç­‰äºå…¶å†…å­˜çš„ç”Ÿå­˜æœŸï¼‰ã€‚</p>

<p>ä¸¾ä¾‹æ¥è¯´ï¼Œæœ‰ä¸Šè¿°ç‰¹å¾çš„ C++ çš„é—­åŒ…å°±æ˜“äºå¼•å‘ä¸ºå®šä¹‰è¡Œä¸ºï¼ˆUndefined Behaviorï¼‰ã€‚å› ä¸ºå…¶å¼•ç”¨æ•è·çš„å±€éƒ¨å˜é‡çš„ç”Ÿå­˜æœŸæ— æ³•è‡ªåŠ¨å»¶é•¿ã€‚è€Œä¾‹å¦‚ Javaï¼ŒJavaScript å’Œ Go çš„é—­åŒ…å°±ä¸ä¼šï¼Œå› ä¸ºå…¶ç¼–è¯‘å™¨ï¼ˆå¯¹äº JavaScript æ¥è¯´å¾€å¾€æ˜¯ JIT ç¼–è¯‘å™¨ï¼‰å°†å¯¹å±€éƒ¨å˜é‡åšé€ƒé€¸åˆ†æï¼ˆEscape Analysisï¼‰ã€‚å°†å¯èƒ½â€œé€ƒé€¸â€çš„å˜é‡ç”Ÿå­˜æœŸå»¶é•¿ï¼Œç”±åƒåœ¾å›æ”¶å™¨è€Œä¸æ˜¯å‡½æ•°è°ƒç”¨æ ˆç»´æŠ¤å…¶ç”Ÿå­˜æœŸã€‚åˆæˆ–è€…å°†æ‰€æœ‰å±€éƒ¨å˜é‡åˆ†é…åœ¨å †ä¸Šç”±åƒåœ¾å›æ”¶å™¨ç»´æŠ¤ä¹Ÿæ˜¯ä¸€æ ·ã€‚</p>

<p>å³ä½¿å¦‚æ­¤ï¼Œå„ä¸ªè¯­è¨€ä¸‹é—­åŒ…çš„åŸºæœ¬è¡¨ç°æ˜¯ä¸å˜çš„ã€‚å› æ­¤ï¼Œé—­åŒ…é€šå¸¸è¢«å®ç°ä¸ºå…¶æ•è·çš„è¯æ³•ç¯å¢ƒå’Œä¸€ä¸ªå‡½æ•°çš„ç»„åˆã€‚</p>

<p>è€ƒè™‘ä¸€ä¸ªåä¸º closureï¼Œè°ƒç”¨æ–¹å¼ä¸º  <code>closure(arg1, arg2, ..., argN)</code>ï¼Œå…¶æ•è·äº†å˜é‡  <code>env_arg1</code>,  <code>env_arg2</code>, &hellip;,  <code>env_argM</code>ã€‚å¯ä»¥å°†å…¶å®ç°ä¸ºä¸€ä¸ªå‡½æ•°å’Œå…¶è¯æ³•ç¯å¢ƒçš„ç»„åˆï¼š</p>

<pre><code>{
    env: (env_arg1, ..., env_argM),
    f: fn(env_arg1, ..., env_argM, arg1, ..., argN),
} 
</code></pre>

<h2 id="https-www-linyinfeng-com-posts-how-do-rust-closures-work-yi-ge-po-su-rust-bi-bao-de-she-ji-yu-shi-xian-ä¸€ä¸ªæœ´ç´ -rust-é—­åŒ…çš„è®¾è®¡ä¸å®ç°"><a href="https://www.linyinfeng.com/posts/how-do-rust-closures-work/#yi-ge-po-su-rust-bi-bao-de-she-ji-yu-shi-xian">ğŸ”—</a>  ä¸€ä¸ªæœ´ç´  Rust é—­åŒ…çš„è®¾è®¡ä¸å®ç°</h2>

<p>ç†è§£äº†é—­åŒ…æ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬å°±å¯ä»¥å†™å‡ºä¸€ä¸ªæœ´ç´ çš„é—­åŒ…ã€‚æœ€ç»ˆæˆ‘ä»¬å®ç°çš„é—­åŒ…<strong>ç”¨èµ·æ¥</strong>å°†ä¼šæœ‰ç‚¹ç¹çï¼ˆæ— è‡ªåŠ¨ç±»å‹æ¨å¯¼ï¼‰ï¼Œä½†è¡Œä¸ºå‡ ä¹ä¸å†…ç½®é—­åŒ…ä¸€è‡´ã€‚æœ€ç»ˆå®ç°å°†ä¼šçœ‹èµ·æ¥åƒä¸€ä¸ªç±»ä¼¼äº C++ 14 Generalized Lambda Capture ç‰¹æ€§çš„é—­åŒ…å®ã€‚</p>

<p>å¦å¤–ï¼Œè™½ç„¶è¿™ä¸ªé—­åŒ…çœ‹èµ·æ¥å°†ä¸å†…ç½®é—­åŒ…å·®ä¸å¤šï¼Œå®é™…ä¸Šçš„åŒºåˆ«æ˜¯æœ‰çš„ï¼Œä¸åªæ˜¯æ— ç±»å‹æ¨å¯¼è¿™ä¸€ç‚¹ï¼Œè¿™äº›å†…å®¹å°†åœ¨å®ç°åä¸€ä¸€é˜è¿°ã€‚</p>

<p>å› ä¸ºæåˆ°äº† C++ 14 Generalized Lambda Capture, æ‰€ä»¥å…ˆè§£é‡Šä¸€ä¸‹è¿™æ˜¯ä»€ä¹ˆç‰¹æ€§ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªä¾‹å­ï¼š</p>

<pre><code class="language-cpp">auto c = [ v = std::move(v) ] { // A generalized capture list do_something_with( v )
}; 
</code></pre>

<p>åœ¨ C++ 14 ä¹‹å‰ï¼Œæ•è·åˆ—è¡¨ä¸­åªèƒ½æŒ‰å€¼æˆ–è€…æŒ‰å¼•ç”¨æ•è·å˜é‡ï¼Œé€šè¿‡ Generalized Lambda Captureï¼ŒC++ å®ç°äº†æ•è·ä»»æ„è¡¨è¾¾å¼ï¼ŒåŒæ—¶ä¹Ÿé¡ºä¾¿å®ç°äº†ç§»åŠ¨æ•è·ã€‚</p>

<p>å…¶å®ï¼ŒRust çš„é—­åŒ…ä¸ C++  <strong>è¯­ä¹‰å’Œä½¿ç”¨ä¸Šçš„è®¾è®¡</strong>å‡ ä¹å¯ä»¥è¯´æ˜¯éå¸¸ç›¸ä¼¼ï¼Œä½†æ˜¯ç”±äº Rust åšå‡ºçš„å†…å­˜å®‰å…¨ï¼ˆMemory Safeï¼‰æ‰¿è¯ºï¼Œå¼•å…¥äº†ä¸‰ä¸ªä¸åŒçš„ traitã€‚å°†è¿™ä¸ªæ”¾åœ¨ä¸€è¾¹ï¼Œæˆ‘ä»¬æŒ‰æœ´ç´ æ€æƒ³å®ç°ä¸€ä¸ªé—­åŒ…çš„ç»“æ„ï¼Œæˆ–è€…è¯´æ•°æ®ã€‚</p>

<p>/// Wrong implementation pub struct Closure<Env, Args, Out> { env: Env, f: fn(Env, Args) -&gt; Out,
}</p>

<p>ç”±äº Rust ä¸­æœ‰å…ƒç»„çš„å­˜åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°æŠŠæ‰€æœ‰æ•è·å˜é‡çš„ç±»å‹ç”¨ä¸€ä¸ªç±»å‹å˜é‡ï¼ˆType Parameterï¼‰<code>Env</code>  è¡¨ç¤ºï¼Œæ‰€æœ‰è°ƒç”¨å‚æ•°çš„ç±»å‹ç”¨  <code>Args</code>  è¡¨ç¤ºï¼Œæœ€åå•ç‹¬ç”¨  <code>Out</code>  è¡¨ç¤ºè°ƒç”¨ç»“æœç±»å‹ã€‚</p>

<p>è€ƒé‡è¿™ä¸ªè®¾è®¡ï¼Œé—­åŒ…å«æœ‰ä¸€ä¸ªç¯å¢ƒå’ŒæŒ‡é’ˆåˆç†å—ï¼Ÿä»<strong>å®ç°åŠŸèƒ½çš„è§’åº¦</strong>æ˜¯åˆç†çš„ï¼ˆåé¢æˆ‘ä»¬å°†çœ‹åˆ°è¿™ä¸ªè®¾è®¡çš„é—®é¢˜æ‰€åœ¨ï¼‰ã€‚</p>

<p>ç»§ç»­è€ƒé‡è¿™ä¸ªè®¾è®¡ã€‚å°†ç¯å¢ƒå®ç°ä¸º  <code>Env</code>  ç±»å‹æ˜¯å¦åˆç†ï¼Ÿåˆç†ï¼Œé—­åŒ…åº”è¯¥æ‹¥æœ‰ï¼ˆOwnï¼‰å…¶æ•è·çš„å†…å®¹ï¼ˆå³ä½¿æ‹¥æœ‰çš„æ˜¯å¼•ç”¨ï¼ˆReferenceï¼‰ä¹Ÿæ˜¯æ‹¥æœ‰ï¼‰ã€‚è¿™äº›å†…å®¹çš„ç”Ÿå­˜æœŸåº”ä¸é—­åŒ…æ˜¯ç›¸åŒçš„ã€‚å°†å‡½æ•°è®¾è®¡ä¸º  <code>fn(Env, Args) -&gt; Out</code>  æ˜¯å¦åˆç†ï¼Ÿå¯¹äºè¿”å›å€¼æ¥è¯´è‚¯å®šæ˜¯åˆç†çš„ï¼Œå¯¹äº  <code>Args</code>  æ¥è¯´ä¹Ÿæ˜¯ï¼Œå› ä¸ºå‡½æ•°è°ƒç”¨çš„æ—¶å€™å°†æ‹¥æœ‰å…¶å‚æ•°ï¼ˆå³ä½¿æ‹¥æœ‰çš„æ˜¯å¼•ç”¨ï¼‰ã€‚å¯¹äºæ‹¥æœ‰å¼•ç”¨çš„æ¦‚å¿µï¼Œå¯ä»¥ä¸¾ä¸€ä¸ªä¾‹å­ï¼š</p>

<pre><code class="language-rust">let v1 = String::new(); 
let v2 = String::new(); 
let mut v3 = String::new(); 
let t = (v1, &amp;v2, &amp;mut v3); 
// Type: (String, &amp;String, &amp;mut String) 
</code></pre>

<p>æ„é€ çš„ tuple å­—é¢é‡æŒ‰è¯­ä¹‰æ¥è¯´ç§»åŠ¨ç»™äº†å˜é‡ tï¼Œå…¶åŒ…å«ä¸¤ä¸ª  <code>String</code>  å¼•ç”¨å¹¶æ‹¥æœ‰ä¸€ä¸ª  <code>String</code>ã€‚</p>

<p>ä½†æ˜¯  <code>Env</code>  çš„è®¾è®¡æ˜¯ä¸åˆç†çš„ï¼Œè¿™æ ·è®¾è®¡æ„å‘³ç€å‡½æ•°å°†è·å¾—é—­åŒ…ä¸­ Closure çš„æ‰€æœ‰æƒå¹¶ä¸å½’è¿˜ï¼Œè¿™æ ·æ­¤é—­åŒ…å°†åªèƒ½è°ƒç”¨ä¸€æ¬¡ã€‚Rust ä¸­ï¼Œå˜é‡å¯ä»¥é€šè¿‡ move,  <code>&amp;mut</code>  å’Œ  <code>&amp;</code>  æ–¹å¼ä¼ é€’å…¥å‡½æ•°ã€‚è¿™ä¸‰ç§æ–¹å¼åœ¨ Rust ç°è¡Œç±»å‹ç³»ç»Ÿä¸­æ˜¯æ— æ³•ç»Ÿä¸€çš„ã€‚å› ä¸º move é—­åŒ…å°†è·å¾—ç¯å¢ƒçš„æ‰€æœ‰æƒï¼Œ<code>&amp;mut</code>  é—­åŒ…å°†é€ æˆå¯¹å…¶ç¯å¢ƒçš„å¯å˜å€Ÿç”¨ï¼ˆMutable borrowingï¼‰ï¼Œ<code>&amp;</code>  é—­åŒ…å°†é€ æˆå¯¹å…¶ç¯å¢ƒçš„ä¸å¯å˜å€Ÿç”¨ï¼ˆImmutable borrowingï¼‰ã€‚Rust çš„ç”Ÿå­˜æœŸæœºåˆ¶å’Œå€Ÿç”¨æ£€æŸ¥å¿…é¡»å¯¹è¿™ä¸‰ç§é—­åŒ…ä½œå‡ºåŒºåˆ«ï¼Œæˆ–è€…è¯´ï¼Œè¿™ä¸‰ç§é—­åŒ…å¿…ç„¶åœ¨è°ƒç”¨æ—¶æºå¸¦ä¸åŒçš„ç±»å‹ä¿¡æ¯ä»¥ç”¨æ¥æ£€æŸ¥ã€‚å¯¹æ¯”ä¹‹ä¸‹ï¼ŒC++ çš„é—­åŒ…åˆ™å¹¶ä¸åŒºåˆ«ï¼Œ<code>operator()</code>  çš„  <code>this</code>  ç±»å‹å¯ä»¥å§‹ç»ˆä¸ºä¸€ä¸ªæŒ‡å‘é—­åŒ…å¯¹è±¡çš„æŒ‡é’ˆã€‚</p>

<p>åŒºåˆ†ä¸‰ç§ä¸åŒçš„  <code>Env</code>  å:</p>

<pre><code class="language-rust">pub struct MoveClosure&lt;Env, Args, Out&gt; { 
env: Env, f: fn(Env, Args) -&gt; Out,
} 
pub struct RefMutClosure&lt;Env, Args, Out&gt; { 
env: Env, f: fn(&amp;mut Env, Args) -&gt; Out,
} 
pub struct RefClosure&lt;Env, Args, Out&gt; {
 env: Env, f: fn(&amp;Env, Args) -&gt; Out,
} 
</code></pre>

<p>å½“æˆ‘ä»¬å†™å‡ºä¸€ä¸ªé—­åŒ…ï¼Œå³å¾€å¾€æ˜¯å†™å‡ºä¸€ä¸ªå‡½æ•°ä½“æ—¶ï¼Œå…¶æºå¸¦çš„å‡½æ•°åº”è¯¥æ˜¯ç”±ç¼–è¯‘å™¨è‡ªåŠ¨æ¨å¯¼å¾—å‡ºçš„ã€‚å¾—ç›Šäº Rust çš„ç±»å‹æ¨å¯¼æœºåˆ¶ï¼ŒRust çš„é—­åŒ…åšåˆ°äº†ï¼Œè€Œ C++ çš„é—­åŒ…å¹¶æ²¡æœ‰åšåˆ°ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ C++ éœ€è¦æ‰‹åŠ¨å†™å‡ºæ•è·åˆ—è¡¨è€Œ Rust ä¸ç”¨ã€‚å½’æ ¹ç»“åº•ï¼ŒRust é—­åŒ…çš„è¿™ä¸‰ç§ç±»å‹æ˜¯ç”±å‡½æ•°ä½“å¯¹é—­åŒ…ç¯å¢ƒçš„ä½¿ç”¨æ–¹å¼å†³å®šçš„ã€‚<strong>ä¸è¦è¯¯å°† Rust å¸¦æœ‰ move å…³é”®å­—çš„é—­åŒ…å’Œ FnOnce å¯¹åº”</strong>ï¼Œä»–ä»¬å®é™…ä¸Šæ²¡æœ‰ä»€ä¹ˆå…³ç³»ã€‚åé¢æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé—­åŒ…åœ¨æ•è·æ—¶å’Œè°ƒç”¨æ—¶çš„è¡Œä¸ºåº”è¯¥åˆ†å¼€åˆ†æã€‚</p>

<p>ä¸ºäº†ä½¿æˆ‘ä»¬çš„é—­åŒ…å¯ä»¥è¢«è°ƒç”¨ï¼Œåº”è¯¥å®ç°å¯¹åº”çš„ traitã€‚ç”±äºä¸Šè¿°åŒºåˆ«ï¼ŒRust å¯¹å¯è°ƒç”¨å¯¹è±¡ä¹Ÿæ— æ³•æœ‰ç±»ä¼¼ C++  <code>operator()</code>  çš„ç»Ÿä¸€çš„ traitã€‚å¯¹ä¸‰ç§ä¸åŒçš„  <code>self</code>  å‚æ•°å¿…é¡»æœ‰ä¸‰ç§ä¸åŒçš„å‡½æ•°ç±»å‹ã€‚å› æ­¤ï¼ŒRust åœ¨  <code>std::ops</code>  ä¸­å®šä¹‰äº†  <code>FnOnce</code>,  <code>FnMut</code>  å’Œ  <code>Fn</code>  ä¸‰ä¸ªä¸åŒçš„ traitï¼š</p>

<pre><code class="language-rust">pub trait FnOnce&lt;Args&gt; { 
type Output; extern &quot;rust-call&quot; 
fn call_once(self, args: Args) -&gt; Self::Output;
} 
pub trait FnMut&lt;Args&gt;: FnOnce&lt;Args&gt; { 
extern &quot;rust-call&quot; fn call_mut(&amp;mut self, args: Args) -&gt; Self::Output;
} 
pub trait Fn&lt;Args&gt;: FnMut&lt;Args&gt; { 
extern &quot;rust-call&quot; fn call(&amp;self, args: Args) -&gt; Self::Output;
} 
</code></pre>

<p>å…¶ä¸­  <code>extern &quot;rust-call&quot;</code>  æ˜¯ä¸“ç”¨äºè¿™å‡ ä¸ª trait çš„è°ƒç”¨çº¦å®šï¼ˆCalling Conventionï¼Œä¸€ç§ ABIï¼‰ï¼ŒåŒºåˆ«äº Rust æœ¬èº«çš„è°ƒç”¨çº¦å®š  <code>extern &quot;Rust&quot;</code>ã€‚</p>

<p>ä¸ºäº†æ‰‹åŠ¨ä¸ºæˆ‘ä»¬çš„å¯¹è±¡å®ç°è¿™ä¸‰ç§ traitï¼Œæˆ‘ä»¬éœ€è¦å¼€å¯ä¸¤ä¸ªä¸ç¨³å®šçš„ Rust ç‰¹æ€§ï¼ˆFeatureï¼‰ï¼š</p>

<p>![feature(fn_traits, unboxed_closures)]</p>

<p>ä¸ºä¸‰ç§é—­åŒ…å®ç°æ‰€æœ‰å¯ä»¥å®ç°çš„ traitï¼š</p>

<p><code>MoveClosure</code>:</p>

<pre><code class="language-rust">impl&lt;Env, Args, Out&gt; FnOnce&lt;Args&gt; for MoveClosure&lt;Env, Args, Out&gt; { 
type Output = Out; 
extern &quot;rust-call&quot; fn call_once(self, args: Args) -&gt; Self::Output {
        (self.f)(self.env, args)
    }
} 
</code></pre>

<p><code>RefMutClosure</code>:</p>

<pre><code class="language-rust">impl&lt;Env, Args, Out&gt; FnOnce&lt;Args&gt; for RefMutClosure&lt;Env, Args, Out&gt; { type Output = Out; extern &quot;rust-call&quot; fn call_once(mut self, args: Args) -&gt; Self::Output {
        (self.f)(&amp;mut self.env, args)
    }
} impl&lt;Env, Args, Out&gt; FnMut&lt;Args&gt; for RefMutClosure&lt;Env, Args, Out&gt; { extern &quot;rust-call&quot; fn call_mut(&amp;mut self, args: Args) -&gt; Self::Output {
        (self.f)(&amp;mut self.env, args)
    }
} 
</code></pre>

<p><code>RefClosure</code>:</p>

<pre><code class="language-rust">impl&lt;Env, Args, Out&gt; FnOnce&lt;Args&gt; for RefClosure&lt;Env, Args, Out&gt; { type Output = Out; extern &quot;rust-call&quot; fn call_once(self, args: Args) -&gt; Self::Output {
        (self.f)(&amp;self.env, args)
    }
} impl&lt;Env, Args, Out&gt; FnMut&lt;Args&gt; for RefClosure&lt;Env, Args, Out&gt; { extern &quot;rust-call&quot; fn call_mut(&amp;mut self, args: Args) -&gt; Self::Output {
        (self.f)(&amp;self.env, args)
    }
} impl&lt;Env, Args, Out&gt; Fn&lt;Args&gt; for RefClosure&lt;Env, Args, Out&gt; { extern &quot;rust-call&quot; fn call(&amp;self, args: Args) -&gt; Self::Output {
        (self.f)(&amp;self.env, args)
    }
} 
</code></pre>

<p>ç¼–å†™è¿‡ç¨‹ä¸­ä¸éš¾å‘ç°ï¼Œæ‰€æœ‰çš„  <code>Fn</code>  ä¸€å®šèƒ½è¢«å®ç°ä¸º  <code>FnMut</code>  å’Œ  <code>FnOnce</code>ï¼Œæ‰€æœ‰çš„  <code>FnMut</code>  ä¸€å®šèƒ½å¤Ÿè¢«å®ç°ä¸º  <code>FnOnce</code>ï¼Œåä¹‹åˆ™ä¸è¡Œã€‚å¯¹äºç¡®å®šçš„å‡½æ•°ä½“ï¼ŒRust å°†é€‰æ‹©æœ€å®½æ¾çš„ä¸€ä¸ªè°ƒç”¨ï¼Œå³æŒ‰ç…§  <code>Fn</code>  &gt;  <code>FnMut</code>  &gt;  <code>FnOnce</code>  çš„ä¼˜å…ˆçº§ã€‚</p>

<p>æœ€åå†ç»™ä¸‰ä¸ªç»“æ„å®ç°åˆ›å»ºé—­åŒ…çš„  <code>new</code>  å‡½æ•°ï¼Œä½œç”¨æ˜¯éšè—å†…éƒ¨ç¯å¢ƒå’Œå‡½æ•°ã€‚</p>

<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥é€šè¿‡ç¿»è¯‘ä¸€äº›ç¨‹åºï¼Œå®é™…ä½¿ç”¨ä¸Šé¢ç¼–å†™çš„é—­åŒ…ï¼š</p>

<pre><code class="language-rust">// å†…ç½®é—­åŒ… let x = 1i32; let c = |y| x + y;
assert_eq!(c(1i32), 2); // æ‰‹åŠ¨å®ç°çš„é—­åŒ… let x = 1i32; let c = { let env = (x,); fn f((x,): &amp;(i32,), (y,): (i32,)) -&gt; i32 {
        x + y
    }
    RefClosure::new(env, f)
};
assert_eq!(c(1), 2); 
</code></pre>

<p>æ³¨æ„ä¸Šä¾‹ä¸­  <code>i32</code>  å®ç°äº†  <code>Copy</code>ã€‚</p>

<p>å…¶ä¸­  <code>let c</code>  ååˆ›å»ºé—­åŒ…çš„å†…å®¹å…¶å®æ˜¯æ¨¡å¼åŒ–çš„ï¼Œç¼–å†™ä¸€ä¸ªç®€å•çš„ macro_rules å®å°†å…¶ç®€åŒ–ï¼š</p>

<pre><code class="language-rust">[macro_export] macro_rules! boxed_closure {
    (move [$($env_name:ident: $env_type:ty = $env_exp:expr,)*]
        ($($arg_name:ident: $arg_type:ty,)*) -&gt; $out:ty $body:block) =&gt; ({ fn f(($($env_name,)*): ($($env_type,)*), ($($arg_name,)*): ($($arg_type,)*)) -&gt; $out $body
        $crate::MoveClosure::new(($($env_exp,)*), f)
    });
    (move [$($env_name:ident: $env_type:ty = $env_exp:expr,)*]
        ($($arg_name:ident: $arg_type:ty,)*) $body:block) =&gt; ({ fn f(($($env_name,)*): ($($env_type,)*), ($($arg_name,)*): ($($arg_type,)*)) $body
        $crate::MoveClosure::new(($($env_exp,)*), f)
    });
    (ref mut [$($env_name:ident: $env_type:ty = $env_exp:expr),*,]
        ($($arg_name:ident: $arg_type:ty),*,) -&gt; $out:ty $body:block) =&gt; ({ fn f(($($env_name,)*): &amp;mut ($($env_type,)*), ($($arg_name,)*): ($($arg_type,)*)) -&gt; $out $body
        $crate::RefMutClosure::new(($($env_exp,)*), f)
    });
    (ref mut [$($env_name:ident: $env_type:ty = $env_exp:expr),*,]
        ($($arg_name:ident: $arg_type:ty),*,) $body:block) =&gt; ({ fn f(($($env_name,)*): &amp;mut ($($env_type,)*), ($($arg_name,)*): ($($arg_type,)*)) $body
        $crate::RefMutClosure::new(($($env_exp,)*), f)
    });
    (ref [$($env_name:ident: $env_type:ty = $env_exp:expr),*,]
        ($($arg_name:ident: $arg_type:ty),*,) -&gt; $out:ty $body:block) =&gt; ({ fn f(($($env_name,)*): &amp;($($env_type,)*), ($($arg_name,)*): ($($arg_type,)*)) -&gt; $out $body
        $crate::RefClosure::new(($($env_exp,)*), f)
    });
    (ref [$($env_name:ident: $env_type:ty = $env_exp:expr),*,]
        ($($arg_name:ident: $arg_type:ty),*,) $body:block) =&gt; ({ fn f(($($env_name,)*): &amp;($($env_type,)*), ($($arg_name,)*): ($($arg_type,)*)) $body
        $crate::RefClosure::new(($($env_exp,)*), f)
    });
} 
</code></pre>

<p>ä¸Šè¿°é—­åŒ…å¯è¢«ç¿»è¯‘ä¸ºï¼š</p>

<pre><code class="language-rust">let x = 1i32; let c = boxed_closure! { ref [x: i32 = x,] (y: i32,) -&gt; i32 {
        x + y
    }
};
assert_eq!(c(1), 2); 
</code></pre>

<p>å®Œæ•´ crate å·²ç»ä¸Šä¼ åˆ° GitHub ä»“åº“  <a href="https://github.com/linyinfeng/closure">linyinfeng/closure</a>ã€‚æ³¨æ„ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€é™‹çš„é—­åŒ…è®¾è®¡ï¼Œä»…ä»…ç”¨äºé˜è¿°ä¸€ä¸ªå…¸å‹é—­åŒ…çš„å·¥ä½œåŸç†ã€‚ç›¸æ¯”äº Rust å†…ç½®é—­åŒ…æ¥è¯´ï¼Œå®ƒçš„è®¾è®¡æ˜¯ç®€æ´çš„ï¼Œä½¿ç”¨æ˜¯ç¹ççš„ï¼Œæ€§èƒ½æ˜¯ä½ä¸‹çš„ã€‚ä¸‹é¢å°†å¯¹ Rust å†…ç½®é—­åŒ…çš„å·¥ä½œè¿›è¡Œåˆ†æå’Œæ¢è®¨ï¼ŒåŒæ—¶ä¹Ÿä¸å®ç°çš„æœ´ç´ é—­åŒ…ä½œæ¯”è¾ƒã€‚</p>

<h2 id="https-www-linyinfeng-com-posts-how-do-rust-closures-work-nei-zhi-bi-bao-å†…ç½®é—­åŒ…"><a href="https://www.linyinfeng.com/posts/how-do-rust-closures-work/#nei-zhi-bi-bao">ğŸ”—</a>  å†…ç½®é—­åŒ…</h2>

<h3 id="https-www-linyinfeng-com-posts-how-do-rust-closures-work-unboxed-unboxed"><a href="https://www.linyinfeng.com/posts/how-do-rust-closures-work/#unboxed">ğŸ”—</a>  Unboxed</h3>

<p>ä¸Šæ–‡å®ç°çš„é—­åŒ…å®é™…ä¸Šä¸å†…ç½®é—­åŒ…éå¸¸ç›¸ä¼¼ï¼Œç¿»è¯‘åä½¿ç”¨èµ·æ¥åŸºæœ¬æ²¡æœ‰åŒºåˆ«ã€‚</p>

<p>ä½†æ˜¯åŒºåˆ«è¿˜æ˜¯æœ‰çš„ï¼Œé¦–å…ˆæ˜¯å…ˆå‰æåˆ°è¿‡çš„æ²¡æœ‰ç±»å‹æ¨å¯¼ï¼Œæ‰€æœ‰æ•è·å’Œç±»å‹éƒ½å¿…é¡»æ˜¾ç¤ºå†™å‡ºã€‚</p>

<p>è€Œæœ€é‡è¦çš„ä¸€ç‚¹æ˜¯ä¸Šæ–‡å¶å°”æåˆ°çš„ boxed å’Œ unboxedï¼Œè¿™æ˜¯ä»€ä¹ˆæ„æ€å‘¢ã€‚å¯ä»¥è¯•éªŒå–ä¸Šæ–‡å®ç°çš„é—­åŒ…çš„ä¸€ä¸ªç»“æ„çš„å¤§å°å’Œå†…ç½®é—­åŒ…çš„å¤§å°ä½œæ¯”è¾ƒï¼š</p>

<pre><code class="language-rust">#![feature(core_intrinsics)] use boxed_closure::boxed_closure; fn type_of&lt;T&gt;(_: &amp;T) -&gt; &amp;'static str { unsafe { std::intrinsics::type_name::&lt;T&gt;() }
} fn size_of&lt;T&gt;(_: &amp;T) -&gt; usize {
    std::mem::size_of::&lt;T&gt;()
} fn main() { let mut s = String::from(&quot;Hello&quot;);
    { let mut c = || s.push('!');
        println!(&quot;Type of a closure c: {}&quot;, type_of(&amp;c));
        println!(&quot;Size of a closure c: {}&quot;, size_of(&amp;c)); c(); c();
    }
    assert_eq!(s, &quot;Hello!!&quot;); let mut s = String::from(&quot;Hello&quot;);
    { let mut c = boxed_closure! { ref mut [s: &amp;mut String = &amp;mut s,] () {
                s.push('!');
            }
        };
        println!(&quot;Type of a closure c: {}&quot;, type_of(&amp;c));
        println!(&quot;Size of a closure c: {}&quot;, size_of(&amp;c)); c(); c();
    }
    assert_eq!(s, &quot;Hello!!&quot;);
} 
</code></pre>

<p>è¾“å‡º</p>

<p>Type of a closure c: [closure@src/main.rs:15:21: 15:35 s:&amp;mut std::string::String]
Size of a closure c: 8
Type of a closure c: closure::RefMutClosure&lt;(&amp;mut std::string::String,), (), ()&gt;
Size of a closure c: 16</p>

<p>åœ¨æˆ‘çš„æœºå™¨ä¸Šå‡½æ•°æŒ‡é’ˆå’Œå¼•ç”¨çš„å¤§å°å‡ä¸º 8ï¼Œå› æ­¤æ•´ä¸ª  <code>RefMutClosure</code>  struct çš„å¤§å°ä¸º 16ã€‚è€Œå†…ç½®é—­åŒ…çš„å¤§å°å´ä»…ä»…ä¸º 8ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>

<p>è¿›ä¸€æ­¥å®éªŒï¼š</p>

<pre><code class="language-rust">let mut s = String::from(&quot;Hello&quot;); let content_of_c: *const ();
{ let mut c = || s.push('!');
    content_of_c = unsafe { std::mem::transmute_copy(&amp;c) }; c(); c();
} let pointer_to_s: *const () = unsafe { std::mem::transmute_copy(&amp;&amp;s) };
assert_eq!(content_of_c, pointer_to_s);
assert_eq!(s, &quot;Hello!!&quot;); 
</code></pre>

<p>å¯è§ Rust å†…ç½®é—­åŒ…å®é™…ä¸Š<strong>åªåŒ…å«äº†ç¯å¢ƒ</strong>ã€‚åŸå› æ˜¯ Rust çš„é—­åŒ…æ˜¯ unboxed é—­åŒ…ï¼Œå…¶å‡½æ•°ç›´æ¥è¢«ç¼–è¯‘å™¨å®šä¹‰åœ¨  <code>FnOnce</code>ï¼Œ<code>FnMut</code>  å’Œ  <code>Fn</code>  çš„å®ç°ä¸­ï¼Œå› æ­¤ï¼Œå†…ç½®é—­åŒ…å¯¹è±¡æ ¹æœ¬ä¸éœ€è¦æºå¸¦å‡½æ•°æŒ‡é’ˆã€‚å¯¹å†…ç½®é—­åŒ…çš„å‡½æ•°è°ƒç”¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹åœ¨ç¼–è¯‘æœŸå°±ç»‘å®šäº†ï¼ˆé™¤éä½¿ç”¨ trait objectï¼‰ï¼Œè€Œä¸æ˜¯è¿è¡Œæ—¶ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯æ–¹ä¾¿ LLVM åšå†…è”ä¼˜åŒ–ï¼ŒåŒæ—¶é—­åŒ…æœ¬èº«ä¹Ÿä¸éœ€è¦é¢å¤–æºå¸¦ä¸€ä¸ªæŒ‡é’ˆäº†ï¼Œå¯ä»¥ç»Ÿä¸€åœ°äº¤ç»™ trait object åšã€‚</p>

<h3 id="https-www-linyinfeng-com-posts-how-do-rust-closures-work-move-guan-jian-zi-move-å…³é”®å­—"><a href="https://www.linyinfeng.com/posts/how-do-rust-closures-work/#move-guan-jian-zi">ğŸ”—</a>  <code>move</code>  å…³é”®å­—</h3>

<p><code>move</code>  å…³é”®å­—çš„æ„ä¹‰æœ‰æ—¶ä»¤äººæ„Ÿåˆ°å›°æƒ‘ã€‚åœ¨è¿œå¤ Rust  <code>ä¸­ï¼Œmove</code>  å…³é”®å­—æ˜¯å¦ä½œä»–ç”¨çš„ï¼Œåæ¥è¢«åˆ é™¤äº†ã€‚åº”è¯¥æ˜¯åœ¨ç°åœ¨ç‰ˆæœ¬çš„é—­åŒ…å‡ºç°ä»¥åæ‰é‡æ–°ä½œä¸ºä¸€ä¸ªæœ‰ç”¨çš„å…³é”®å­—å‡ºç°ã€‚åœ¨å†…ç½®é—­åŒ…æ•è·å˜é‡çš„æ—¶å€™ï¼ŒRust æ€»æ˜¯å°½å¯èƒ½ä»¥  <code>&amp;</code>  &gt;  <code>&amp;mut</code>  &gt;  <code>move</code>  çš„é¡ºåºè¿›è¡Œæ•è·ï¼Œè¿™å°†å¯¹æ•è·çš„å˜é‡äº§ç”Ÿæœ€å°‘çš„å½±å“ã€‚ä½†æ˜¯ï¼ŒæŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦é—­åŒ…è·å¾—å˜é‡çš„æ‰€æœ‰æƒï¼Œä½†æ˜¯é—­åŒ…å‡½æ•°ä½“å¹¶ä¸éœ€è¦è·å¾—å˜é‡çš„æ‰€æœ‰æƒã€‚è¿™æ—¶å€™æˆ‘ä»¬ä½¿ç”¨  <code>move</code>  å…³é”®å­—å¼ºåˆ¶ Rust å°†æ‰€æœ‰æ•è·çš„å˜é‡ç§»åŠ¨å…¥é—­åŒ…çš„ç¯å¢ƒä¸­ï¼Œä»¥å»¶é•¿è¢«ç§»åŠ¨çš„å¯¹è±¡çš„ç”Ÿå­˜æœŸã€‚</p>

<p>å¯ä»¥è€ƒè™‘ä¸€ä¸‹ä¸ºä»€ä¹ˆæœ‰  <code>move</code>  é—­åŒ…å´æ²¡æœ‰  <code>mut</code>  é—­åŒ…å‘¢ï¼Ÿå› ä¸ºå¼ºåˆ¶  <code>mut</code>  æ•è·å¹¶ä¸ä¼šé€ æˆä»»ä½•çš„å¥½å¤„å´ä¼šå¯¹è¢«æ•è·çš„å˜é‡äº§ç”Ÿä¸€ä¸ªå¯å˜å€Ÿç”¨ï¼Œè¿™æ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œå°±ä¸å†™äº†  <code>let r = &amp;mut x;</code>  å´ä¸ä¿®æ”¹ r ä¸€æ ·ï¼Œç¼–è¯‘å™¨å°†æç¤ºå»é™¤  <code>mut</code>ã€‚</p>

<h3 id="https-www-linyinfeng-com-posts-how-do-rust-closures-work-fn-fnmut-fnonce-de-tui-dao-fn-fnmut-fnonce-çš„æ¨å¯¼"><a href="https://www.linyinfeng.com/posts/how-do-rust-closures-work/#fn-fnmut-fnonce-de-tui-dao">ğŸ”—</a>  <code>Fn</code>ï¼Œ<code>FnMut</code>ï¼Œ<code>FnOnce</code>  çš„æ¨å¯¼</h3>

<p>æ­£å¦‚ä¹‹å‰åå¤å¼ºè°ƒçš„ï¼Œé—­åŒ…ç©¶ç«Ÿå®ç°  <code>Fn</code>ï¼Œ<code>FnMut</code>ï¼Œ<code>FnOnce</code>  ä¸­çš„å“ªå‡ ä¸ª traitï¼Œæ˜¯ç”±é—­åŒ…å¯¹ç¯å¢ƒçš„ä½¿ç”¨ï¼Œä¹Ÿå°±æ˜¯å‡½æ•°ä½“å†³å®šçš„ã€‚</p>

<p>ä¸¾ä¸ªä¾‹å­ï¼š</p>

<pre><code class="language-rust">let s = String::from(&quot;hello&quot;); let c = move || println!(&quot;{}&quot;, s); c(); c(); 
</code></pre>

<p>èƒ½æ­£å¸¸è¿è¡Œï¼Œè¾“å‡ºï¼š</p>

<p>s = hello
s = hello</p>

<pre><code class="language-rust">let s = String::from(&quot;hello&quot;); let c = || dbg!(s);
println!(&quot;{}&quot;, s); c(); c(); 
</code></pre>

<p>å°†ç¼–è¯‘é”™è¯¯ï¼š</p>

<p>error[E0382]: borrow of moved value: <code>s</code>
error[E0382]: use of moved value: <code>c</code></p>

<p>è¿™æ˜¯å› ä¸º  <code>dbg!(s)</code>  å°†è·å–  <code>s</code>  çš„æ‰€æœ‰æƒå†è¿”å›  <code>s</code>ï¼Œè€Œ  <code>println!(&quot;{}&quot;, s)</code>  åªä¼šè·å–  <code>s</code>  çš„å¼•ç”¨ã€‚åŒæ ·ï¼Œ<code>s</code>  è¢«ç§»åŠ¨è¿›ç¬¬ä¸€ä¸ªé—­åŒ…æ˜¯å› ä¸º  <code>move</code>  å…³é”®å­—çš„ä½œç”¨ï¼Œè€Œ  <code>s</code>  è¢«ç§»åŠ¨è¿›ç¬¬äºŒä¸ªé—­åŒ…æ˜¯å› ä¸ºç¬¬äºŒä¸ªé—­åŒ…çš„å‡½æ•°ä½“è¦æ±‚  <code>s</code>  çš„æ‰€æœ‰æƒã€‚å³ä½¿ä¸¤ä¸ªä¾‹å­ä¸­  <code>s</code>  å‡è¢«ç§»åŠ¨è¿›é—­åŒ…ï¼Œç¬¬ä¸€ä¸ªé—­åŒ…ä¾ç„¶æ ¹æ®å‡½æ•°ä½“è¢«å®ç°äº†  <code>Fn</code>ï¼Œ<code>FnMut</code>ï¼Œ<code>FnOnce</code>ï¼Œç¬¬äºŒä¸ªé—­åŒ…è¢«æ ¹æ®å‡½æ•°ä½“å®ç°äº†  <code>FnOnce</code>ã€‚</p>

<h3 id="https-www-linyinfeng-com-posts-how-do-rust-closures-work-bi-bao-de-mut-é—­åŒ…çš„-mut"><a href="https://www.linyinfeng.com/posts/how-do-rust-closures-work/#bi-bao-de-mut">ğŸ”—</a>  é—­åŒ…çš„  <code>mut</code></h3>

<p>ä¸‹é¢ç¤ºä¾‹ä»£ç ä¸­çš„  <code>c</code>  å˜é‡æœ‰æ—¶å€™ä¹Ÿä»¤äººæ„Ÿåˆ°å›°æƒ‘ã€‚</p>

<pre><code class="language-rust">let mut s = String::from(&quot;Hello&quot;);
{ let mut c = || s.push('!'); // ! c(); c();
}
assert_eq!(s, &quot;Hello!!&quot;); 
</code></pre>

<p>ä¸ºä»€ä¹ˆç¼–è¯‘å™¨è¦æ±‚ c å¿…é¡»æ˜¯å¯å˜çš„æ‰èƒ½æ‰§è¡Œ c() å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºä¸èƒ½é€šè¿‡ä¸å¯å˜å¼•ç”¨é—­åŒ…ä¿®æ”¹å…¶å†…å®¹ï¼ŒåŒ…æ‹¬å…¶ä¸­çš„å¯å˜å¼•ç”¨ã€‚å¦ä¸€æ–¹é¢ï¼Œä¹Ÿå¯ä»¥ä»ç±»å‹ä¸Šçœ‹ï¼Œæ— æ³•å°†ä¸å¯å˜çš„å†…ç½®é—­åŒ…ä¼ é€’ç»™è¦æ±‚å¯å˜ self å¼•ç”¨çš„ call_mutã€‚</p>

<h2 id="https-www-linyinfeng-com-posts-how-do-rust-closures-work-tuo-chi-bi-bao-è„±ç¦»é—­åŒ…"><a href="https://www.linyinfeng.com/posts/how-do-rust-closures-work/#tuo-chi-bi-bao">ğŸ”—</a>  è„±ç¦»é—­åŒ…</h2>

<p>Rust ä¸­ï¼Œæœ€ç®€å•é«˜é˜¶å‡½æ•°ä¸€èˆ¬é€šè¿‡è¢«è¿™æ ·ä¹¦å†™ï¼š</p>

<p>fn higher_order_fn<F>(f: F) where F: Fn() -&gt; i32,</p>

<p>ä¸ç†ä¼šå¯¹ F çš„æ›´å¤šçº¦æŸï¼Œè€ƒè™‘åœ¨ç¼–å†™é«˜é˜¶å‡½æ•°æ—¶ï¼Œåº”è¯¥é€‰æ‹©  <code>FnOnce</code>ï¼Œ<code>FnMut</code>  è¿˜æ˜¯  <code>Fn</code>ï¼Ÿ</p>

<p><code>FnOnce</code>ï¼Œ<code>FnMut</code>  å’Œ  <code>Fn</code>  å¹¶éåªä¸ºé—­åŒ…æœåŠ¡ã€‚ä¸ç®¡æ˜¯æˆ‘ä»¬å®ç°çš„æœ´ç´ é—­åŒ…ä¹Ÿå¥½ï¼Œè¿˜æ˜¯æ™®é€šå‡½æ•°ä¹Ÿå¥½ï¼Œéƒ½å®ç°äº†è¿™å‡ ä¸ª traitsã€‚äº‹å®ä¸Šï¼š</p>

<pre><code class="language-rust">fn main() {
    println!(&quot;{}&quot;, std::mem::size_of_val(&amp;main)); // 0 } 
</code></pre>

<p>Rust ä¸­çš„å‡½æ•°ä¹Ÿæ˜¯â€œunboxedâ€œå®ç°ï¼ŒåŒæ ·ä¹Ÿå®ç°äº†  <code>Fn</code>  ç³»åˆ— traitsã€‚</p>

<p>æ‰€ä»¥æˆ‘æƒ³æœ€ååº”è¯¥ä»å¦ä¸€ä¸ªå±‚é¢å†æ¬¡è€ƒè™‘  <code>FnOnce</code>ï¼Œ<code>FnMut</code>  å’Œ  <code>Fn</code>ï¼Œä»¥è‡³äºåœ¨å®è·µä¸­ï¼Œç†è§£å…¶è¯­ä¹‰åº”å½“å°±èƒ½ä½œå‡ºæ­£ç¡®çš„é€‰æ‹©ï¼š</p>

<ul>
<li><code>Fn</code>ï¼Œå‡½æ•°ä¸ä¿æœ‰è‡ªå·±çš„çŠ¶æ€</li>
<li><code>FnMut</code>ï¼Œå‡½æ•°å¯ä»¥æ”¹å˜è‡ªå·±çš„çŠ¶æ€</li>
<li><code>FnOnce</code>ï¼Œå‡½æ•°æ¶ˆè´¹è‡ªå·±çš„çŠ¶æ€</li>
</ul>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼š</p>

<ul>
<li>éœ€è¦çº¯å‡½æ•°çš„æ—¶å€™ï¼Œä¹¦å†™  <code>Fn</code></li>
<li>éœ€è¦å‡½æ•°ä¿å­˜å†…éƒ¨çŠ¶æ€çš„æ—¶å€™ï¼Œå¦‚ä¼ªéšæœºæ•°ç”Ÿæˆå‡½æ•°ï¼Œä¹¦å†™  <code>FnMut</code></li>

<li><p>ç±»ä¼¼äºåˆ›å»ºçº¿ç¨‹è¿™æ ·çš„è°ƒç”¨ï¼Œé€‰æ‹©  <code>FnOnce</code></p>

<pre><code class="language-rust">pub fn spawn&lt;F, T&gt;(f: F) -&gt; JoinHandle&lt;T&gt; where
 F: FnOnce() -&gt; T, F: Send + 'static,
 T: Send + 'static,
</code></pre></li>
</ul>

</div>


    </main>

    
  </body>
</html>
